---
- name: Set ip forwarding in the sysctl file and reload if necessary
  sysctl:
    name: "net.ipv4.ip_forward"
    value: 1
    sysctl_set: yes
    state: present
    reload: yes

- name: Enable IPv4 traffic forwarding - (/proc/sys/net/ipv4/ip_forward)
  command: echo 1 > /proc/sys/net/ipv4/ip_forward

- name: Enable the iptables service
  service:
    name: iptables
    state: started
    enabled: yes

- name: Add the iptables MASQUERADE rule
  iptables:
    table: nat
    chain: POSTROUTING
    out_interface: "{{ ansible_default_ipv4.interface }}"
    protocol: all
    source: "{{ openvpn_network }}/24"
    jump: MASQUERADE
    comment: "Perform NAT readdressing for OpenVPN"
  register: masquerade_done
  #me added the line here for iptables
- name: Add IP adress MASQUERADE rule
  command: /sbin/iptables -I FORWARD -s 172.18.0.0/16 -j ACCEPT
#- name: Add the iptables MASQUERADE rule
#   command: /sbin/iptables -t nat -A POSTROUTING -s 10.8.0.0/16 -o eth0 -j MASQUERADE
  #me added the line here for iptables
- name: perfomss NAT readdressingme
  command: /sbin/iptables -I FORWARD -s 172.18.0.0/16 -j ACCEPT
#- name: iptables - Perform NAT readdressing
#   command: /sbin/iptables -I FORWARD -s 10.8.0.0/16 -j ACCEPT
  #me added the line here for iptables
- name: allow port 443
  command: /sbin/iptables -I INPUT -p tcp -m tcp --dport 443 -j ACCEPT
#- name: iptables - Allow port 443
#   command: /sbin/iptables -I INPUT -p tcp -m tcp --dport 443 -j ACCEPT
  #me added the line here for iptables
- name: reject icmp-host-prohibited
  command: /sbin/iptables -D FORWARD -j REJECT --reject-with icmp-host-prohibited
#  command: /bin/false
#  ignore_errors: yes
#- name: iptables -Reject prohibited ICPM
#   command: /sbin/iptables -D FORWARD  -j REJECT --reject-with icmp-host-prohibited
#   command: /bin/false
#   ignore_errors: yes

- name: Save the rules
  command: service iptables save
  when: masquerade_done.changed
